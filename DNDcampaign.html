<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D&D Campaign Creator</title>
  <link rel="stylesheet" href="Campaignstyles.css" />
  <!-- Font Awesome for social media icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <a href="index.html" class="back-button">← Back to Home</a>

  <div class="container">
    <h1>Your Campaigns</h1>
    <button id="openModalBtn" class="add-campaign-btn">+ Add New Campaign</button>

    <!-- Campaign Cards Container -->
    <div id="campaign-list" class="campaign-list">
      <!-- Campaign cards will be inserted here by JavaScript -->
    </div>
  </div>

  <!-- Create/Edit Campaign Modal -->
  <div id="campaignModal" class="modal">
    <div class="modal-content">
      <span class="close" id="createModalClose">×</span>
      <h2 id="modal-title">New Campaign</h2>
      <form id="campaign-form">
        <!-- Hidden input for editing -->
        <input type="hidden" id="campaign-id" name="campaign-id">

        <label for="campaign-name">Campaign Name:</label>
        <input type="text" id="campaign-name" name="campaign-name" required />

        <label for="campaign-description">Description:</label>
        <textarea id="campaign-description" name="campaign-description" rows="4" required></textarea>

        <fieldset>
          <legend>Enemy Types</legend>
          <div class="checkbox-grid">
            <label><input type="checkbox" name="enemy-types" value="Undead" /> Undead</label>
            <label><input type="checkbox" name="enemy-types" value="Monsters" /> Monsters</label>
            <label><input type="checkbox" name="enemy-types" value="Beasts" /> Beasts</label>
            <label><input type="checkbox" name="enemy-types" value="Celestial" /> Celestial</label>
            <label><input type="checkbox" name="enemy-types" value="Dragon" /> Dragon</label>
            <label><input type="checkbox" name="enemy-types" value="Mystics" /> Mystics</label>
            <label class="others-label">
              <input type="checkbox" id="enemy-others-checkbox" name="enemy-types" value="Others" /> Others:
              <input type="text" id="enemy-others-text" name="enemy-others-text" placeholder="Specify..." disabled />
            </label>
          </div>
        </fieldset>

        <fieldset>
          <legend>Secrets</legend>
          <div class="checkbox-grid">
            <label><input type="checkbox" name="secrets" value="Room" /> Secret Rooms</label>
            <label><input type="checkbox" name="secrets" value="Traps" /> Hidden Traps</label>
            <label><input type="checkbox" name="secrets" value="Chests" /> Locked Chests</label>
          </div>
        </fieldset>

        <label for="difficulty">Difficulty:</label>
        <select id="difficulty" name="difficulty" required>
          <option value="" disabled selected>Select difficulty</option>
          <option value="Easy">Easy</option>
          <option value="Medium">Medium</option>
          <option value="Hard">Hard</option>
          <option value="Nightmare">Nightmare</option>
        </select>

        <button type="submit" id="save-campaign-btn">Save Campaign</button>
      </form>
    </div>
  </div>

  <!-- Display Campaign Details Modal -->
  <div id="detailModal" class="modal">
    <div class="modal-content detail-modal-content">
      <span class="close" id="detailModalClose">×</span>
      <h2 id="detail-name"></h2>
      <p><strong>Description:</strong></p>
      <p id="detail-description"></p>
      <p><strong>Enemy Types:</strong> <span id="detail-enemies"></span></p>
      <p><strong>Secrets:</strong> <span id="detail-secrets"></span></p>
      <p><strong>Difficulty:</strong> <span id="detail-difficulty" class="difficulty-tag"></span></p>
    </div>
  </div>
  
  <!-- Footer Section -->
  <footer class="footer">
      <div class="comments-section">
          <h3>Leave a Comment</h3>
          <textarea placeholder="Share your thoughts..."></textarea>
          <button>Submit Comment</button>
      </div>
      <div class="social-buttons">
          <a href="https://www.facebook.com" target="_blank" class="icon-button"><i class="fab fa-facebook-f"></i></a>
          <a href="https://github.com/Gutierrez-DCET" target="_blank" class="icon-button"><i class="fab fa-github"></i></a>
          <a href="https://discord.com" target="_blank" class="icon-button"><i class="fab fa-discord"></i></a>
      </div>
      <p>&copy; 2024 Tabletop Nexus. All rights reserved.</p>
  </footer>

  <!-- Firebase SDK Imports and Initialization -->
  <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, collection, doc, addDoc, getDoc, updateDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Firebase configuration and initialization (global for access in campaign.js)
      const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

      let app;
      let db;
      let auth;
      let currentUserId = null;

      // Initialize Firebase and set up authentication
      try {
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          // Listen for authentication state changes
          onAuthStateChanged(auth, async (user) => {
              if (user) {
                  // User is signed in.
                  currentUserId = user.uid;
                  console.log("User signed in:", currentUserId);
                  // Ensure the script can access these globals after auth is ready
                  window.firebaseApp = app;
                  window.firestoreDb = db;
                  window.firebaseAuth = auth;
                  window.currentUserId = currentUserId;
                  window.appId = appId; // Pass appId to the global scope

                  // Load the main script (campaign.js) only after Firebase is ready
                  const script = document.createElement('script');
                  script.src = 'campaign.js';
                  script.type = 'module'; // Ensure it's treated as a module
                  document.body.appendChild(script);

              } else {
                  // User is signed out, or not yet signed in.
                  console.log("No user signed in. Attempting anonymous sign-in...");
                  try {
                      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                          await signInWithCustomToken(auth, __initial_auth_token);
                          console.log("Signed in with custom token.");
                      } else {
                          await signInAnonymously(auth);
                          console.log("Signed in anonymously.");
                      }
                  } catch (error) {
                      console.error("Firebase Auth Error:", error);
                  }
              }
          });
      } catch (error) {
          console.error("Failed to initialize Firebase:", error);
          // Potentially show an error message on the page if Firebase fails to load
          document.getElementById('campaign-list').innerHTML = '<p style="color: red;">Error: Failed to load campaign data. Please try again.</p>';
      }
  </script>
</body>
</html>
